<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Streamlit Video Recorder</title>
    <script
        src="https://cdn.jsdelivr.net/npm/streamlit-component-lib@1.4.0/dist/streamlit-component-lib.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: transparent;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 640px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }

        video {
            width: 100%;
            border-radius: 12px;
            background: #111827;
            transform: scaleX(-1);
            /* Mirror for natural feel */
            object-fit: cover;
            aspect-ratio: 4 / 3;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-record {
            background-color: #ef4444;
            color: white;
        }

        .btn-record:hover {
            background-color: #dc2626;
        }

        .btn-record.recording {
            animation: pulse 1.5s infinite;
        }

        .btn-stop {
            background-color: #374151;
            color: white;
        }

        .btn-stop:hover {
            background-color: #1f2937;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .status {
            font-size: 14px;
            color: #4b5563;
            text-align: center;
            min-height: 20px;
        }

        .timer {
            font-weight: 700;
            color: #ef4444;
        }
    </style>
</head>

<body>
    <div class="container" id="main-container">
        <video id="preview" autoplay muted playsinline></video>
        <div class="status" id="status-text">Ready to record</div>
        <div class="controls">
            <button id="record-btn" class="btn btn-record">
                <span id="record-icon">ðŸ”´</span>
                <span id="record-text">Record 15s Clip</span>
            </button>
        </div>
    </div>

    <script>
        const video = document.getElementById('preview');
        const recordBtn = document.getElementById('record-btn');
        const statusText = document.getElementById('status-text');
        const container = document.getElementById('main-container');

        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let timeLeft = 15;

        // Initialize Streamlit with safety
        function init() {
            try {
                if (typeof Streamlit !== 'undefined') {
                    Streamlit.events.addEventListener(Streamlit.EVENTS.RENDERER, () => {
                        Streamlit.setFrameHeight(container.offsetHeight + 40);
                    });
                    Streamlit.setComponentReady();
                    console.log("Streamlit component ready");
                } else {
                    console.warn("Streamlit JS not found, retrying...");
                    setTimeout(init, 100);
                }
            } catch (err) {
                console.error("Streamlit init error:", err);
            }
        }

        // Start Preview immediately
        async function startPreview() {
            try {
                statusText.innerText = "Requesting Camera...";
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                video.srcObject = stream;
                statusText.innerText = "Camera Active";
            } catch (err) {
                console.error("Camera error:", err);
                statusText.innerText = "âŒ Camera Error: " + err.message;
                statusText.style.color = "#ef4444";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            init();
            startPreview();
        });

        recordBtn.onclick = () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                startRecording();
            }
        };

        function startRecording() {
            recordedChunks = [];
            // Try different mime types
            const types = [
                'video/webm;codecs=vp8',
                'video/webm',
                'video/mp4'
            ];

            let selectedType = types.find(t => MediaRecorder.isTypeSupported(t)) || '';

            try {
                mediaRecorder = new MediaRecorder(stream, { mimeType: selectedType });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    clearInterval(timerInterval);
                    const blob = new Blob(recordedChunks, { type: selectedType });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        if (typeof Streamlit !== 'undefined') {
                            Streamlit.setComponentValue({
                                status: "success",
                                data: base64String,
                                type: selectedType
                            });
                        }
                    };
                    statusText.innerText = "âœ… Clip captured! Processing...";
                    recordBtn.style.display = 'none';
                };

                mediaRecorder.start();

                // UI Update
                recordBtn.classList.add('recording');
                recordBtn.disabled = true;
                timeLeft = 15;
                statusText.innerHTML = `Recording... <span class="timer">${timeLeft}s</span> remaining`;

                timerInterval = setInterval(() => {
                    timeLeft--;
                    statusText.innerHTML = `Recording... <span class="timer">${timeLeft}s</span> remaining`;
                    if (timeLeft <= 0) {
                        stopRecording();
                    }
                }, 1000);

            } catch (err) {
                console.error("Recording error:", err);
                statusText.innerText = "âŒ Recording failed: " + err.message;
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
        }
    </script>
</body>

</html>