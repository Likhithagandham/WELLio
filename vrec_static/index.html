<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>WELLio Pro Recorder</title>
    <script
        src="https://cdn.jsdelivr.net/npm/streamlit-component-lib@1.4.0/dist/streamlit-component-lib.min.js"></script>
    <style>
        :root {
            --primary: #ef4444;
            --primary-dark: #dc2626;
            --bg-glass: rgba(255, 255, 255, 0.7);
            --bg-dark: #111827;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        body {
            margin: 0;
            padding: 10px;
            font-family: 'Inter', -apple-system, sans-serif;
            background: transparent;
            display: flex;
            justify-content: center;
        }

        .premium-card {
            width: 100%;
            max-width: 600px;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            background: var(--bg-dark);
            border-radius: 18px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .overlay {
            position: absolute;
            inset: 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .face-guide {
            width: 50%;
            height: 60%;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .recording .face-guide {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            padding: 6px 14px;
            background: #f3f4f6;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
        }

        .recording .status-dot {
            background: var(--primary);
            animation: pulse-dot 1s infinite;
        }

        .btn-main {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.2);
            width: 100%;
        }

        .btn-main:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.3);
        }

        .btn-main:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-main:disabled {
            background: #d1d5db;
            box-shadow: none;
            cursor: not-allowed;
        }

        @keyframes pulse-dot {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        canvas {
            display: none;
        }
    </style>
</head>

<body>
    <div class="premium-card" id="card">
        <div class="video-container" id="video-box">
            <video id="preview" autoplay muted playsinline></video>
            <div class="overlay">
                <div class="face-guide"></div>
            </div>
        </div>

        <div class="controls">
            <div class="status-badge" id="status-badge">
                <div class="status-dot"></div>
                <span id="status-text">Initializing Camera...</span>
            </div>

            <button id="record-btn" class="btn-main">
                Record 15s Health Scan
            </button>
        </div>
    </div>

    <!-- Hidden canvas for fixed 30fps capture -->
    <canvas id="capture-canvas" width="640" height="480"></canvas>

    <script>
        const video = document.getElementById('preview');
        const canvas = document.getElementById('capture-canvas');
        const ctx = canvas.getContext('2d');
        const recordBtn = document.getElementById('record-btn');
        const statusText = document.getElementById('status-text');
        const card = document.getElementById('card');
        const videoBox = document.getElementById('video-box');

        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let captureInterval;
        let timeLeft = 15;

        // Initialize Streamlit Connection
        function initStreamlit() {
            try {
                if (window.Streamlit) {
                    Streamlit.events.addEventListener(Streamlit.EVENTS.RENDERER, () => {
                        Streamlit.setFrameHeight(document.body.scrollHeight + 50);
                    });
                    Streamlit.setComponentReady();
                } else {
                    setTimeout(initStreamlit, 100);
                }
            } catch (err) { console.error(err); }
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user", width: 640, height: 480 },
                    audio: false
                });
                video.srcObject = stream;
                statusText.innerText = "Ready for Scan";
                initStreamlit();
            } catch (err) {
                statusText.innerText = "Camera Access Denied";
                statusText.parentElement.style.color = "#ef4444";
            }
        }

        recordBtn.onclick = () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                startRecording();
            }
        };

        function startRecording() {
            recordedChunks = [];
            videoBox.classList.add('recording');
            recordBtn.disabled = true;

            // Create a fixed 30FPS stream from Canvas
            const canvasStream = canvas.captureStream(30);

            // Setup MediaRecorder
            const options = { mimeType: 'video/webm;codecs=vp8' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/mp4';

            mediaRecorder = new MediaRecorder(canvasStream, options);
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };

            mediaRecorder.onstop = () => {
                clearInterval(timerInterval);
                clearInterval(captureInterval);
                const blob = new Blob(recordedChunks, { type: options.mimeType });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    if (window.Streamlit) {
                        Streamlit.setComponentValue({
                            status: "success",
                            data: reader.result,
                            type: options.mimeType,
                            fps: 30
                        });
                    }
                };
                statusText.innerText = "Scan Complete! Analyzing...";
            };

            // Start Canvas drawing loop (Fixed 30fps)
            captureInterval = setInterval(() => {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }, 1000 / 30);

            mediaRecorder.start();

            timeLeft = 15;
            statusText.innerText = `Recording... ${timeLeft}s`;
            timerInterval = setInterval(() => {
                timeLeft--;
                statusText.innerText = `Recording... ${timeLeft}s`;
                if (timeLeft <= 0) mediaRecorder.stop();
            }, 1000);
        }

        window.onload = startCamera;
    </script>
</body>

</html>